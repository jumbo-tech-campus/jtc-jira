<%= render 'shared/nav_bar' %>
<main role="main" class="container-fluid">
  <div class="main">
    <div class="row pl-3 mb-3">
      <ul class="nav">
        <% @teams.each do |team| %>
        <li class="nav-item">
          <a class="btn btn-outline-jumbo btn-sm shadow-sm mb-1 mr-2 <%= 'active' if @board.id == team.board_id %>"
            href="<%= cycle_time_report_path(board_id: team.board_id) %>">
            <%= team.name %>
          </a>
        </li>
       <% end %>
      </ul>
     </div>
     <div class="card box-shadow mb-4">
       <div class="card-header">
         <strong><%= @board.team.name %>: Cycle time scatter plot</strong><br>
         <small class="text-muted small">Cycle time is calculated from the first transition to 'In progress' to the last transition to 'Done'</small>
       </div>
       <div class="scatter-plot m-4"></div>
     </div>

     <script>
     $(function() {
       var chart_data = convertToCycleTimeChartData(JSON.parse('<%= raw(@stats.to_json) %>'));
       c3.generate({
           padding: {
              right: 40,
              left: 40
           },
           bindto: d3.select('.scatter-plot'),
           data: {
             xs: {
               'cycle time': 'cycle_time_x',
               trendline: 'trendline_x',
               'moving average': 'moving_average_x'
             },
             columns: chart_data,
             type: 'scatter',
             types: {
               trendline: 'line',
               'moving average': 'line'
             }
           },
           axis: {
             y: {
               min: 0,
               padding: { top: 5, bottom:0 }
             },
             x: {
               type: 'timeseries',
               tick: {
                fit: true,
                count: 6,
                format: '%d-%m-%Y'
               }
             }
           },
           point: {
             r: 5,
             show: false
           }
         });
       });
    </script>
   <% if @stats[:short_cycle_trendline].any? %>

    <div class="card box-shadow mb-4">
      <div class="card-header">
        <strong><%= @board.team.name %>: Short cycle time scatter plot</strong><br>
        <small class="text-muted small">Short cycle time is calculated from the first transition to 'In progress' to the last transition to 'Ready for prod'</small>
      </div>
      <div class="scatter-plot-2 m-4"></div>
    </div>

    <script>
    $(function() {
      var chart_data = convertToShortCycleTimeChartData(JSON.parse('<%= raw(@stats.to_json) %>'));
      c3.generate({
          padding: {
             right: 40,
             left: 40
          },
          bindto: d3.select('.scatter-plot-2'),
          data: {
            xs: {
              'cycle time': 'cycle_time_x',
              trendline: 'trendline_x',
              'moving average': 'moving_average_x'
            },
            columns: chart_data,
            type: 'scatter',
            types: {
              trendline: 'line',
              'moving average': 'line'
            }
          },
          axis: {
            y: {
              min: 0,
              padding: { top: 5, bottom:0 }
            },
            x: {
              type: 'timeseries',
              tick: {
               fit: true,
               count: 6,
               format: '%d-%m-%Y'
              }
            }
          },
          point: {
            r: 5,
            show: false
          }
        });
    });
   </script>
<% end %>
     <div class="card box-shadow mb-4">
       <div class="card-header">
         <a href="<%= cycle_time_report_path(board_id: @board.id, format: 'csv') %>"
           class="card-link float-right">
           Download as csv file
         </a>
         <strong><%= @board.team.name %>: Cycle time overview</strong><br>
       </div>
       <div class="card-body">
         <table class="table table-bordered">
             <thead>
               <tr class="small">
                 <% @table[0].each do |header_item| %>
                 <th><%= header_item %></th>
                 <% end %>
               </tr>
             </thead>
             <tbody>
               <% @table[1..-1].each do |row| %>
               <tr class="small">
                 <% row.each_with_index do |row_item, index| %>
                <td class="<%= 'text-center' unless index == 0 %>">
                  <% if index == 0 %>
                  <a href="<%= URI.join(ENV['JIRA_SITE'], "browse/", row_item)%>" target="_blank"><%= row_item %></a>
                  <% else %>
                  <%= row_item %>
                  <% end %>                </td>
                <% end %>
              </tr>
              <% end %>
             </tbody>
         </table>
       </div>
    </div>
  </div>
</main>
